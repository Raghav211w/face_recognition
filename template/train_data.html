{% extends "base.html" %}

{% block content %}
<style>
    /* --- Import Google Font --- */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    /* --- CSS Variables for Theme --- */
    :root {
        --primary-color: #4A6CFA;
        --primary-light: #E9EFFF;
        --secondary-color: #6C757D;
        --success-color: #28a745;
        --info-color: #17a2b8;
        --warning-color: #ffc107;
        --danger-color: #DC3545;
        --background-color: #F8F9FA;
        --card-background: #FFFFFF;
        --text-color: #212529;
        --text-muted: #6C757D;
        --border-color: #DEE2E6;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --border-radius: 12px;
    }

    /* --- Base Styles --- */
    body {
        background-color: var(--background-color);
        font-family: 'Poppins', sans-serif;
    }

    /* --- Main Wrapper --- */
    .dashboard-wrapper {
        padding: 2rem;
        background-color: var(--background-color);
        border-radius: var(--border-radius);
    }

    /* --- Main Card Style --- */
    .card.main-card {
        background-color: var(--card-background);
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .main-card .card-header {
        background-color: var(--card-background);
        color: var(--text-color);
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem;
        font-weight: 600;
    }
    
    .main-card .card-body {
        padding: 1.5rem;
    }

    /* --- Form & Input Styles --- */
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    .form-control {
        border-radius: 8px !important;
        border: 1px solid var(--border-color) !important;
        padding: 0.6rem 1rem !important;
    }
    .form-control:focus {
        box-shadow: 0 0 0 2px var(--primary-light) !important;
        border-color: var(--primary-color) !important;
    }

    /* --- Student Search Dropdown --- */
    #studentDropdown {
        border-radius: 0 0 8px 8px;
        box-shadow: var(--shadow);
        border-color: var(--border-color) !important;
    }
    #studentDropdown > div {
        cursor: pointer;
        padding: 0.75rem 1rem;
    }
    #studentDropdown > div:hover {
        background-color: var(--primary-light);
    }

    /* --- Button Styles --- */
    .btn {
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
    }
    .btn-success { background-color: var(--success-color); color: #fff; }
    .btn-success:hover { background-color: #218838; }
    .btn-danger { background-color: var(--danger-color); color: #fff; }
    .btn-danger:hover { background-color: #c82333; }
    .btn-warning { background-color: var(--warning-color); color: #212529; }
    .btn-warning:hover { background-color: #e0a800; }
    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
    .btn-outline-secondary {
        border: 1px solid var(--secondary-color);
        color: var(--secondary-color);
        background-color: transparent;
    }
    .btn-outline-secondary:hover {
        background-color: var(--secondary-color);
        color: #fff;
    }

    /* --- Video & Canvas --- */
    #video {
        border-radius: var(--border-radius);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid var(--border-color);
        background-color: #000;
    }

    /* --- Training Controls --- */
    #trainingControls h5 {
        font-weight: 600;
        margin-bottom: 1rem;
    }
    .progress {
        height: 1.5rem;
        border-radius: var(--border-radius);
        background-color: #e9ecef;
    }
    .progress-bar {
        background-color: var(--success-color);
        font-weight: 600;
    }
    
    /* --- Alert & Info Boxes --- */
    .alert {
        border-radius: var(--border-radius);
        padding: 1rem;
        border: none;
    }
    .alert-info {
        background-color: var(--primary-light);
        color: var(--primary-color);
    }
    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
    }
    .alert-success {
        background-color: #d4edda;
        color: #155724;
    }
    #commands h6 {
        font-weight: 700;
    }

</style>

<div class="dashboard-wrapper">
    <div class="card main-card">
        <div class="card-header">
            <h3 class="mb-0">Train Face Recognition Data</h3>
        </div>
        <div class="card-body">
            <div id="debugInfo" class="alert alert-secondary mb-3" style="display: none;">
                <strong>Debug:</strong> <span id="debugMessage"></span>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h5>Student Selection</h5>
                    <form id="studentForm">
                        <div class="mb-3">
                            <label for="studentSearch" class="form-label">Search and Select Student</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="studentSearch" placeholder="Search by name or roll number..." autocomplete="off">
                                <div id="studentDropdown" class="position-absolute w-100 bg-white" style="display: none; max-height: 200px; overflow-y: auto; z-index: 1000;">
                                </div>
                            </div>
                            <input type="hidden" id="selectedStudentId" name="student_id" required>
                            <div id="selectedStudentDisplay" class="mt-2" style="display: none;">
                                <small class="text-muted">Selected: <strong id="selectedStudentName"></strong></small>
                                <button type="button" id="clearSelection" class="btn btn-sm btn-outline-secondary ms-2">Clear</button>
                            </div>
                        </div>
                        <button type="button" id="startTraining" class="btn btn-success">Start Training</button>
                    </form>
                    
                    <div id="trainingControls" style="display: none;" class="mt-3">
                        <h5>Training Progress</h5>
                        <div class="progress mb-3">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0/50</div>
                        </div>
                        <div id="commands" class="alert alert-info">
                            <h6 class="mb-1">Follow these commands:</h6>
                            <p id="currentCommand" class="mb-1">Position yourself in front of the camera</p>
                            <p id="commandProgress" class="mb-0"><small>Preparing...</small></p>
                        </div>
                        <div id="faceDetectionStatus" class="alert alert-warning">
                            <p id="faceStatus" class="mb-0">Detecting face...</p>
                        </div>
                        <button type="button" id="startAutoCapture" class="btn btn-success">Start Auto Capture</button>
                        <button type="button" id="stopAutoCapture" class="btn btn-danger" style="display: none;">Stop Auto Capture</button>
                        <button type="button" id="finishTraining" class="btn btn-warning" style="display: none;">Finish Training</button>
                        <button type="button" id="stopTraining" class="btn btn-danger">Stop Training</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Camera Preview</h5>
                    <video id="video" width="100%" height="auto" autoplay playsinline muted></video>
                    <canvas id="canvas" width="400" height="300" style="display: none;"></canvas>
                    <div id="capturedPhotos" class="mt-2">
                        <h6>Captured Photos: <span id="photoCount">0</span></h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- Your existing script remains unchanged ---
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let photoCount = 0;
let currentStudentId = null;
let trainingCommands = [
    { command: "Look straight ahead", photos: 8 },
    { command: "Look up", photos: 6 },
    { command: "Look down", photos: 6 },
    { command: "Look left", photos: 6 },
    { command: "Look right", photos: 6 },
    { command: "Tilt head left", photos: 4 },
    { command: "Tilt head right", photos: 4 },
    { command: "Smile", photos: 4 },
    { command: "Neutral expression", photos: 4 },
    { command: "Look slightly up-left", photos: 2 },
    { command: "Look slightly up-right", photos: 2 },
    { command: "Look slightly down-left", photos: 2 },
    { command: "Look slightly down-right", photos: 2 }
];
let currentCommandIndex = 0;
let currentCommandPhotos = 0;
let isAutoCapturing = false;
let autoCaptureInterval;
let faceDetectionInterval; 


function updateDebugInfo(message) {
    const debugInfoElement = document.getElementById('debugInfo');
    const debugMessageElement = document.getElementById('debugMessage');
    if (debugInfoElement && debugMessageElement) {
        debugMessageElement.textContent = message;
        debugInfoElement.style.display = 'block';
        console.log("DEBUG: " + message);
    }
}

async function startCamera() {
    updateDebugInfo('Attempting to start camera...');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            video.play();
            updateDebugInfo('Camera started. Video metadata loaded.');
            if (!faceDetectionInterval) {
                faceDetectionInterval = setInterval(checkFaceDetection, 2000);
            }
        };
        video.onerror = (event) => {
            console.error('Video element error:', event);
            updateDebugInfo('Video element encountered an error. Check camera connection.');
        };
    } catch (err) {
        console.error('Error accessing camera:', err);
        let errorMessage = 'Unknown camera error.';
        if (err.name === 'NotAllowedError') {
            errorMessage = 'Camera access denied by user. Please allow permissions.';
        } else if (err.name === 'NotFoundError') {
            errorMessage = 'No camera found. Please ensure a webcam is connected.';
        } else if (err.name === 'NotReadableError') {
            errorMessage = 'Camera is in use by another application or not accessible.';
        }
        alert('Error accessing camera: ' + errorMessage);
        updateDebugInfo('Camera error: ' + errorMessage + ' - ' + err.message);
    }
}

let allStudents = [];

async function loadStudents() {
    try {
        updateDebugInfo('Loading students from server...');
        const response = await fetch('/get_students');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        allStudents = data;
        updateDebugInfo(`Successfully loaded ${allStudents.length} students.`);
        filterStudents();
    } catch (error) {
        console.error('Error loading students:', error);
        updateDebugInfo(`Error loading students: ${error.message}.`);
    }
}

function filterStudents() {
    const searchInput = document.getElementById('studentSearch');
    const dropdown = document.getElementById('studentDropdown');
    const searchTerm = searchInput.value.toLowerCase().trim();
    dropdown.innerHTML = '';
    
    if (searchTerm === '' && document.activeElement !== searchInput) {
        dropdown.style.display = 'none';
        return;
    }
    
    const filteredStudents = allStudents.filter(student => 
        student.name.toLowerCase().includes(searchTerm) || 
        String(student.roll_no).toLowerCase().includes(searchTerm)
    );
    
    if (filteredStudents.length === 0) {
        dropdown.innerHTML = '<div class="p-2 text-muted">No students found</div>';
    } else {
        filteredStudents.forEach(student => {
            const option = document.createElement('div');
            option.innerHTML = `<strong>${student.name}</strong> <small class="text-muted">(${student.roll_no}) - ${student.department}</small>`;
            option.addEventListener('click', () => selectStudent(student));
            dropdown.appendChild(option);
        });
    }
    dropdown.style.display = 'block';
}

function selectStudent(student) {
    document.getElementById('studentSearch').value = `${student.name} (${student.roll_no})`;
    document.getElementById('selectedStudentId').value = student.id;
    document.getElementById('selectedStudentName').textContent = `${student.name} (${student.roll_no})`;
    document.getElementById('selectedStudentDisplay').style.display = 'block';
    document.getElementById('studentDropdown').style.display = 'none';
    updateDebugInfo(`Selected student: ${student.name} (ID: ${student.id})`);
    document.getElementById('startTraining').disabled = false; 
}

function clearSelection() {
    document.getElementById('studentSearch').value = '';
    document.getElementById('selectedStudentId').value = '';
    document.getElementById('selectedStudentDisplay').style.display = 'none';
    updateDebugInfo('Student selection cleared.');
    document.getElementById('startTraining').disabled = true;
}

function startTraining() {
    const studentId = document.getElementById('selectedStudentId').value;
    if (!studentId) {
        alert('Please select a student first.');
        return;
    }
    currentStudentId = studentId;
    photoCount = 0;
    currentCommandIndex = 0;
    currentCommandPhotos = 0;
    document.getElementById('studentForm').style.display = 'none';
    document.getElementById('trainingControls').style.display = 'block';
    updateCommand();
    updateProgress();
    updateDebugInfo(`Training started for student ID: ${currentStudentId}`);
}

function updateCommand() {
    if (currentCommandIndex < trainingCommands.length) {
        const command = trainingCommands[currentCommandIndex];
        document.getElementById('currentCommand').textContent = `Command: ${command.command}`;
        document.getElementById('commandProgress').innerHTML = `<small>Photos for this pose: ${currentCommandPhotos}/${command.photos}</small>`;
    } else {
        document.getElementById('currentCommand').textContent = 'All poses completed! Click Finish Training.';
        document.getElementById('commandProgress').textContent = '';
        document.getElementById('startAutoCapture').style.display = 'none';
        document.getElementById('stopAutoCapture').style.display = 'none';
        showFinishButton();
    }
}

function updateProgress() {
    const progress = Math.min((photoCount / 50) * 100, 100);
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressBar').textContent = `${photoCount}/50`;
    document.getElementById('photoCount').textContent = photoCount;
}

async function checkFaceDetection() {
    if (!video.srcObject || !currentStudentId) return false;
    if (video.paused || video.ended) return false;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL('image/jpeg');
    
    try {
        const response = await fetch('/capture_training_photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: currentStudentId, image: imageData, photo_index: -1 })
        });
        const result = await response.json();
        const faceStatusEl = document.getElementById('faceDetectionStatus');
        if (result.success) {
            faceStatusEl.querySelector('p').textContent = 'Face detected! Ready to capture.';
            faceStatusEl.className = 'alert alert-success';
            return true;
        } else {
            faceStatusEl.querySelector('p').textContent = `No face detected or multiple faces: ${result.message}`;
            faceStatusEl.className = 'alert alert-warning';
            return false;
        }
    } catch (error) {
        console.error('Error checking face detection:', error);
        return false;
    }
}

async function capturePhoto() {
    if (photoCount >= 50) {
        stopAutoCapture();
        showFinishButton();
        return;
    }

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL('image/jpeg');
    
    try {
        const response = await fetch('/capture_training_photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: currentStudentId, image: imageData, photo_index: photoCount })
        });
        const result = await response.json();
        if (result.success) {
            photoCount++;
            currentCommandPhotos++;
            if (currentCommandIndex < trainingCommands.length && currentCommandPhotos >= trainingCommands[currentCommandIndex].photos) {
                currentCommandIndex++;
                currentCommandPhotos = 0;
            }
            updateCommand();
            updateProgress();
            if (photoCount >= 10) showFinishButton();
        }
    } catch (error) {
        console.error('Error capturing photo:', error);
    }
}

function startAutoCapture() {
    if (isAutoCapturing) return;
    isAutoCapturing = true;
    document.getElementById('startAutoCapture').style.display = 'none';
    document.getElementById('stopAutoCapture').style.display = 'inline-block';
    updateDebugInfo('Auto-capture started.');
    autoCaptureInterval = setInterval(capturePhoto, 1000);
}

function stopAutoCapture() {
    if (!isAutoCapturing) return;
    isAutoCapturing = false;
    clearInterval(autoCaptureInterval);
    document.getElementById('startAutoCapture').style.display = 'inline-block';
    document.getElementById('stopAutoCapture').style.display = 'none';
    updateDebugInfo('Auto-capture stopped manually.');
}

function showFinishButton() {
    document.getElementById('finishTraining').style.display = 'inline-block';
}

async function finishTraining() {
    stopAutoCapture();
    updateDebugInfo('Attempting to finalize training...');
    try {
        const response = await fetch('/finish_training', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: currentStudentId })
        });
        const result = await response.json();
        if (result.success) {
            alert(`Training completed successfully! Model updated.`);
            resetTraining();
        } else {
            alert('Error finishing training: ' + result.message);
        }
    } catch (error) {
        console.error('Error finishing training:', error);
        alert('Error communicating with server to finish training.');
    }
}

function resetTraining() {
    stopAutoCapture();
    if (faceDetectionInterval) {
        clearInterval(faceDetectionInterval);
        faceDetectionInterval = null;
    }
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
    document.getElementById('studentForm').style.display = 'block';
    document.getElementById('trainingControls').style.display = 'none';
    photoCount = 0;
    currentStudentId = null;
    updateProgress();
    clearSelection();
    document.getElementById('finishTraining').style.display = 'none';
    startCamera();
}

function stopTraining() {
    if (confirm('Are you sure you want to stop training? Progress will be lost.')) {
        resetTraining();
    }
}

document.getElementById('startTraining').addEventListener('click', startTraining);
document.getElementById('startAutoCapture').addEventListener('click', startAutoCapture);
document.getElementById('stopAutoCapture').addEventListener('click', stopAutoCapture);
document.getElementById('finishTraining').addEventListener('click', finishTraining);
document.getElementById('stopTraining').addEventListener('click', stopTraining);

window.addEventListener('load', () => {
    document.getElementById('startTraining').disabled = true; 
    startCamera();
    loadStudents();
    document.getElementById('studentSearch').addEventListener('input', filterStudents);
    document.getElementById('studentSearch').addEventListener('focus', filterStudents);
    document.getElementById('clearSelection').addEventListener('click', clearSelection);
    document.addEventListener('click', (e) => {
        const searchContainer = document.getElementById('studentSearch').parentElement;
        if (!searchContainer.contains(e.target)) {
            document.getElementById('studentDropdown').style.display = 'none';
        }
    });
});
</script>
{% endblock %}
